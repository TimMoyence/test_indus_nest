version: 2.1
orbs:
  node: circleci/node@5

jobs:
  # Stage BUILD : Installation, Analyse, Cleaning & Packaging
  build:
    executor: node/default
    steps:
      - checkout
      - run: echo "ğŸš€ Build - Installation des dÃ©pendances..."
      - run: echo "ğŸ” Build - Analyse de code en cours..."
      - run: echo "ğŸ§¹ Build - Cleaning et Packaging de l'application..."

  # Stage TESTS (jobs lancÃ©s en parallÃ¨le aprÃ¨s le build)
  unit-tests:
    executor: node/default
    environment:
      JEST_JUNIT_OUTPUT_DIR: ./test-results/
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run: echo "ğŸ§ª Unit tests - Lancement des tests complets..."
      - run:
          command: npm install jest-junit
      - run:
          name: Run tests
          command: npm run test:ci
      - store_test_results:
          path: ./test-results/

  integration_tests:
    executor: node/default
    steps:
      - checkout
      - run: echo "ğŸ¤– Integration tests - On vÃ©rifie les interactions..."

  regression_tests:
    executor: node/default
    steps:
      - checkout
      - run: echo "ğŸ” Regression tests - Ã€ la chasse aux rÃ©gressions..."

  performance_tests:
    executor: node/default
    steps:
      - checkout
      - run: echo "ğŸï¸ Performance tests - Boostons la vitesse !"

  security_tests:
    executor: node/default
    steps:
      - checkout
      - run: echo "ğŸ›¡ï¸ Security tests - RenforÃ§ons la sÃ©curitÃ© !"

  compatibility_tests:
    executor: node/default
    steps:
      - checkout
      - run: echo "ğŸ”§ Compatibility tests - Tout s'assemble bien ?"

  accessibility_tests:
    executor: node/default
    steps:
      - checkout
      - run: echo "ğŸŒˆ Accessibility tests - Pour une appli accessible et fun !"

  # Job minimal pour les branches hotfix (tests rÃ©duits)
  minimal-tests:
    executor: node/default
    steps:
      - checkout
      - run: echo "âš¡ Hotfix detected - ExÃ©cution des tests essentiels uniquement..."
      - run: echo "âœ… Tests minimaux validÃ©s avec succÃ¨s !"

  # Stage DEPLOY
  deploy_development:
    executor: node/default
    steps:
      - checkout
      - run: echo "ğŸŒ± DÃ©ploiement DEV - PrÃ©paration de l'environnement..."
      - run: echo "ğŸš€ DÃ©ploiement DEV - Lancement de l'application..."
      - run: echo "ğŸ” VÃ©rifications et validation fonctionnelle..."

  deploy_integration:
    executor: node/default
    steps:
      - checkout
      - run: echo "ğŸš§ DÃ©ploiement INTÃ‰GRATION - PrÃ©paration et dÃ©ploiement..."
      - run: echo "âœ… Tests de validation et charge..."

  deploy_production:
    executor: node/default
    steps:
      - checkout
      - run: echo "ğŸ‰ DÃ©ploiement PROD - En production, c'est parti !"
      - run: echo "ğŸ”’ VÃ©rifications, validations et monitoring activÃ© !"

workflows:
  version: 2

  # Pipeline complet pour les branches "develop", "integration" et "main"
  full_pipeline:
    jobs:
      - build:
          filters:
            branches:
              ignore:
                - /^hotfix\/.*$/
                - /^feature\/.*$/
      # Lancement parallÃ¨le des tests (ils ne dÃ©pendent que du build)
      - unit-tests:
          requires: [build]
          filters:
            branches:
              ignore:
                - /^hotfix\/.*$/
                - /^feature\/.*$/
      - integration_tests:
          requires: [build]
          filters:
            branches:
              ignore:
                - /^hotfix\/.*$/
                - /^feature\/.*$/
      - regression_tests:
          requires: [build]
          filters:
            branches:
              ignore:
                - /^hotfix\/.*$/
                - /^feature\/.*$/
      - performance_tests:
          requires: [build]
          filters:
            branches:
              ignore:
                - /^hotfix\/.*$/
                - /^feature\/.*$/
      - security_tests:
          requires: [build]
          filters:
            branches:
              ignore:
                - /^hotfix\/.*$/
                - /^feature\/.*$/
      - compatibility_tests:
          requires: [build]
          filters:
            branches:
              ignore:
                - /^hotfix\/.*$/
                - /^feature\/.*$/
      - accessibility_tests:
          requires: [build]
          filters:
            branches:
              ignore:
                - /^hotfix\/.*$/
                - /^feature\/.*$/
      # DÃ©ploiement - chaque job attend que tous les tests soient terminÃ©s
      - deploy_development:
          requires:
            - unit-tests
            - integration_tests
            - regression_tests
            - performance_tests
            - security_tests
            - compatibility_tests
            - accessibility_tests
          filters:
            branches:
              only: develop
      - deploy_integration:
          requires:
            - unit-tests
            - integration_tests
            - regression_tests
            - performance_tests
            - security_tests
            - compatibility_tests
            - accessibility_tests
          filters:
            branches:
              only: integration
      - deploy_production:
          requires:
            - unit-tests
            - integration_tests
            - regression_tests
            - performance_tests
            - security_tests
            - compatibility_tests
            - accessibility_tests
          filters:
            branches:
              only: main

  # Pipeline minimal pour les branches hotfix (et Ã©ventuellement feature)
  hotfix_pipeline:
    jobs:
      - build:
          filters:
            branches:
              only:
                - /^hotfix\/.*$/
      - minimal-tests:
          requires: [build]
          filters:
            branches:
              only:
                - /^hotfix\/.*$/
      - deploy_development:
          requires: [minimal-tests]
          filters:
            branches:
              only:
                - /^hotfix\/.*$/
